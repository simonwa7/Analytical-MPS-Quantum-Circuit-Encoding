from src.encoding._kak_decomposition import _is_unitary, _get_unitary_form_of_mps_site
import numpy as np
import pytest
import copy

SEED = 1234
np.random.seed(SEED)


@pytest.mark.parametrize(
    "matrix",
    [
        np.eye(1),
        np.eye(2),
        np.eye(3),
        np.eye(4),
        np.asarray([[0, 1], [1, 0]]),
        np.asarray([[0, -1j], [1j, 0]]),
        np.asarray([[1, 0], [0, -1]]),
    ],
)
def test_matrix_is_unitary(matrix):
    assert _is_unitary(matrix)


@pytest.mark.parametrize(
    "matrix",
    [
        np.zeros((1, 1)),
        np.zeros((2, 2)),
        np.zeros((3, 3)),
        np.zeros((4, 4)),
        (1 / np.sqrt(2)) * np.asarray([[1, 1], [1, 1]]),
        np.asarray([[0, 1j], [0, -1j]]),
    ],
)
def test_matrix_is_not_unitary(matrix):
    assert not _is_unitary(matrix)


@pytest.mark.parametrize(
    "matrix",
    [
        np.eye(1),
        np.eye(2),
        np.eye(3),
        np.eye(4),
        np.asarray([[0, 1], [1, 0]]),
        np.asarray([[0, -1j], [1j, 0]]),
        np.asarray([[1, 0], [0, -1]]),
    ],
)
def test_matrix_is_unitary_doesnt_destroy_input(matrix):
    copied_matrix = copy.deepcopy(matrix)
    _is_unitary(matrix)
    assert np.array_equal(copied_matrix, matrix)


@pytest.mark.parametrize(
    "mps",
    [
        np.asarray(
            [
                np.array(
                    [
                        [
                            [0.00879084 - 0.82593794j, 0.54831125 + 0.13078228j],
                            [0.15806571 - 0.54107713j, -0.72178992 - 0.40158447j],
                        ]
                    ]
                ),
                np.array(
                    [
                        [[-0.68228437 + 0.0j], [-0.59976315 + 0.14825111j]],
                        [[0.05340337 + 0.0j], [-0.05725301 + 0.01415196j]],
                    ]
                ),
            ]
        ),
        np.asarray(
            [
                np.array(
                    [
                        [
                            [
                                -0.31833974 + 2.41521036e-17j,
                                0.94797669 + 3.09146926e-16j,
                            ],
                            [
                                -0.78882345 + 5.25754103e-01j,
                                -0.26489454 + 1.76553312e-01j,
                            ],
                        ]
                    ]
                ),
                np.array(
                    [
                        [
                            [-0.67625691 + 0.06045265j, -0.35059608 - 0.62994351j],
                            [-0.6467187 + 0.34115664j, 0.50890643 + 0.41687548j],
                        ],
                        [
                            [0.0368319 + 0.01559575j, -0.07875288 - 0.15746212j],
                            [0.0498018 + 0.01758143j, -0.12434149 - 0.03202334j],
                        ],
                    ]
                ),
                np.array(
                    [
                        [[-0.75564449 + 0.0j], [-0.62376404 - 0.09858886j]],
                        [[-0.00975735 + 0.0j], [0.01153223 + 0.00182272j]],
                    ]
                ),
            ]
        ),
        np.asarray(
            [
                np.array(
                    [
                        [
                            [
                                -0.86192274 + 0.00000000e00j,
                                0.50703964 - 5.23821202e-17j,
                            ],
                            [
                                -0.30508999 + 4.04980605e-01j,
                                -0.51862612 + 6.88431374e-01j,
                            ],
                        ]
                    ]
                ),
                np.array(
                    [
                        [
                            [-0.1519075 - 0.72123781j, 0.30311082 - 0.53465278j],
                            [-0.4077469 - 0.47412683j, -0.08546831 + 0.71911853j],
                        ],
                        [
                            [-0.08530453 - 0.16781612j, 0.08277328 + 0.20547359j],
                            [-0.14379074 - 0.09783381j, 0.08303049 - 0.20461936j],
                        ],
                    ]
                ),
                np.array(
                    [
                        [
                            [
                                -0.82281354 + 1.95156391e-18j,
                                -0.3653432 + 4.23754961e-01j,
                            ],
                            [
                                -0.56126835 - 7.97493718e-02j,
                                0.6184525 - 5.38684430e-01j,
                            ],
                        ],
                        [
                            [0.02757129 - 1.13841228e-18j, 0.0422954 - 5.83471438e-02j],
                            [
                                0.02736883 - 9.30222947e-03j,
                                0.06259122 - 7.19771555e-02j,
                            ],
                        ],
                    ]
                ),
                np.array(
                    [
                        [[0.67633078 + 0.0j], [0.6831207 - 0.04982997j]],
                        [[0.02662667 + 0.0j], [-0.02622249 + 0.00191279j]],
                    ]
                ),
            ]
        ),
        np.asarray(
            [
                np.array(
                    [
                        [
                            [
                                -0.80215864 + 6.46069192e-18j,
                                0.59711098 + 5.16855353e-17j,
                            ],
                            [
                                -0.50389719 + 3.20357823e-01j,
                                -0.67693528 + 4.30368567e-01j,
                            ],
                        ]
                    ]
                ),
                np.array(
                    [
                        [
                            [-0.68089719 - 0.19459216j, 0.47035717 + 0.47242776j],
                            [-0.59308392 - 0.21974256j, -0.37524807 - 0.50760621j],
                        ],
                        [
                            [0.00394559 - 0.23433654j, 0.14347553 - 0.35492969j],
                            [0.03615906 - 0.20552596j, -0.10223147 + 0.00945462j],
                        ],
                    ]
                ),
                np.array(
                    [
                        [
                            [-0.51272901 - 0.44591927j, 0.63478602 + 0.36666965j],
                            [-0.72573323 - 0.10653424j, -0.6787265 + 0.03108652j],
                        ],
                        [
                            [-0.01117279 - 0.00772075j, 0.00238159 + 0.01164435j],
                            [-0.0061602 + 0.00207711j, 0.02845668 + 0.00360468j],
                        ],
                    ]
                ),
                np.array(
                    [
                        [
                            [
                                -0.74443443 + 1.02999206e-18j,
                                -0.58622611 + 2.02551420e-01j,
                            ],
                            [
                                -0.58548276 - 2.79527329e-01j,
                                0.72371254 + 1.31714092e-01j,
                            ],
                        ],
                        [
                            [
                                0.11973073 + 2.53771071e-18j,
                                0.01855395 + 1.52598412e-01j,
                            ],
                            [
                                0.09181783 + 4.61066897e-02j,
                                0.15854077 + 1.59492104e-01j,
                            ],
                        ],
                    ]
                ),
                np.array(
                    [
                        [
                            [-0.72918925 + 0.00000000e00j],
                            [-0.65440348 - 2.11083720e-03j],
                        ],
                        [
                            [-0.01350641 + 0.00000000e00j],
                            [0.01504977 + 4.85443949e-05j],
                        ],
                    ]
                ),
            ]
        ),
        np.asarray(
            [
                np.array(
                    [
                        [
                            [-0.69039636 + 0.0j, 0.72343131 + 0.0j],
                            [-0.72200435 + 0.04541572j, -0.68903456 + 0.04334184j],
                        ]
                    ]
                ),
                np.array(
                    [
                        [
                            [-0.6593401 - 0.33232498j, 0.55450632 + 0.36827845j],
                            [-0.66226855 + 0.00475623j, -0.73041228 - 0.09732852j],
                        ],
                        [
                            [0.08641424 + 0.0866833j, 0.0576578 - 0.00984696j],
                            [0.01471323 - 0.03178988j, -0.08445647 - 0.0580043j],
                        ],
                    ]
                ),
                np.array(
                    [
                        [
                            [-0.53160504 - 0.57513675j, 0.41019508 - 0.46127657j],
                            [-0.61036758 - 0.11454955j, -0.06397176 + 0.77470235j],
                        ],
                        [
                            [0.00352315 + 0.00462317j, 0.0791576 + 0.0614329j],
                            [0.02130506 + 0.02135251j, 0.0633095 + 0.0256863j],
                        ],
                    ]
                ),
                np.array(
                    [
                        [
                            [-0.48725677 - 0.49756225j, 0.12542789 + 0.53673707j],
                            [-0.20194881 - 0.58923165j, -0.15723329 - 0.53964801j],
                        ],
                        [
                            [0.19963843 + 0.19338305j, -0.19086599 + 0.42708093j],
                            [0.11239741 + 0.19274256j, -0.38378203 - 0.1188372j],
                        ],
                    ]
                ),
                np.array(
                    [
                        [
                            [
                                -0.71337302 - 1.16443313e-16j,
                                -0.15245278 + 6.80971046e-01j,
                            ],
                            [
                                -0.62731972 - 3.10924292e-01j,
                                0.44755646 - 5.49004344e-01j,
                            ],
                        ],
                        [
                            [
                                -0.02100019 + 5.04154010e-18j,
                                -0.00359062 - 8.73475452e-02j,
                            ],
                            [
                                -0.00618442 - 2.03895964e-02j,
                                0.00095277 - 6.06682454e-02j,
                            ],
                        ],
                    ]
                ),
                np.array(
                    [
                        [[0.44838701 + 0.0j], [0.82571211 - 0.06903894j]],
                        [[-0.05089167 + 0.0j], [0.02744388 - 0.00229462j]],
                    ]
                ),
            ]
        ),
        np.asarray(
            [
                np.array(
                    [
                        [
                            [
                                -0.88295404 + 0.00000000e00j,
                                0.46945943 - 6.83275249e-18j,
                            ],
                            [
                                -0.45519344 + 1.14852476e-01j,
                                -0.85612272 + 2.16013251e-01j,
                            ],
                        ]
                    ]
                ),
                np.array(
                    [
                        [
                            [-0.49600489 + 0.17467359j, 0.58202036 + 0.37594991j],
                            [-0.7122018 + 0.21818426j, -0.1994634 - 0.1307684j],
                        ],
                        [
                            [0.16971391 - 0.34707343j, 0.42346618 - 0.2443191j],
                            [-0.11864059 - 0.07276094j, 0.4616457 - 0.10438274j],
                        ],
                    ]
                ),
                np.array(
                    [
                        [
                            [-0.49022097 - 0.61853152j, 0.1174592 - 0.09964756j],
                            [-0.30196588 - 0.21267219j, -0.39077623 + 0.70066143j],
                        ],
                        [
                            [0.27279714 + 0.35085083j, -0.13518933 + 0.06452839j],
                            [0.12087348 + 0.16900983j, -0.30801581 + 0.46403383j],
                        ],
                    ]
                ),
                np.array(
                    [
                        [
                            [-0.37257874 - 0.53550276j, 0.6149652 - 0.42753237j],
                            [-0.27544438 - 0.70351837j, -0.59110303 + 0.22493519j],
                        ],
                        [
                            [0.01727949 + 0.04063624j, 0.10651041 - 0.12609248j],
                            [0.02254584 + 0.03399962j, 0.07260709 - 0.08074447j],
                        ],
                    ]
                ),
                np.array(
                    [
                        [
                            [-0.57345049 - 0.73624701j, 0.04751928 - 0.35107082j],
                            [-0.13522992 - 0.32760981j, -0.36359895 + 0.85887371j],
                        ],
                        [
                            [-0.03185635 - 0.02268155j, -0.0211324 + 0.05040412j],
                            [-0.03359447 - 0.02866513j, -0.00969096 - 0.03926681j],
                        ],
                    ]
                ),
                np.array(
                    [
                        [
                            [
                                -0.63143843 - 1.49619900e-17j,
                                -0.45037416 - 5.98635522e-01j,
                            ],
                            [
                                -0.54210849 + 5.13033974e-01j,
                                0.62183618 + 9.58805330e-02j,
                            ],
                        ],
                        [
                            [
                                0.19281391 - 6.50521303e-19j,
                                -0.03800444 - 9.17587543e-02j,
                            ],
                            [
                                0.05684655 - 6.15735770e-02j,
                                0.18162202 - 8.64584218e-03j,
                            ],
                        ],
                    ]
                ),
                np.array(
                    [
                        [[-0.74374854 + 0.0j], [-0.61522115 + 0.05044273j]],
                        [[-0.02136808 + 0.0j], [0.02565964 - 0.00210387j]],
                    ]
                ),
            ]
        ),
        np.asarray(
            [
                np.array(
                    [
                        [
                            [
                                -0.27629346 - 4.86433576e-17j,
                                0.96107332 - 2.43216788e-17j,
                            ],
                            [
                                -0.87288151 + 4.02168858e-01j,
                                -0.25093971 + 1.15617221e-01j,
                            ],
                        ]
                    ]
                ),
                np.array(
                    [
                        [
                            [-0.38916936 - 0.63293278j, 0.49235663 - 0.18595621j],
                            [-0.53771919 - 0.07540479j, -0.08027986 + 0.74653871j],
                        ],
                        [
                            [0.14313082 + 0.29041074j, 0.17782929 + 0.07042165j],
                            [0.15863599 + 0.15207002j, -0.06971925 + 0.34321582j],
                        ],
                    ]
                ),
                np.array(
                    [
                        [
                            [-0.85931187 - 0.21930206j, 0.36802571 - 0.27079042j],
                            [-0.26817676 - 0.36939371j, -0.88545843 - 0.05175232j],
                        ],
                        [
                            [0.01847954 + 0.02993527j, 0.0602839 + 0.0065425j],
                            [-0.01873011 - 0.0594205j, 0.02767318 + 0.00848096j],
                        ],
                    ]
                ),
                np.array(
                    [
                        [
                            [-0.42698783 - 0.21416289j, 0.64579497 - 0.21042899j],
                            [-0.73604592 - 0.33172166j, -0.38243522 - 0.00471266j],
                        ],
                        [
                            [-0.33978156 + 0.05898076j, 0.16150389 + 0.23854662j],
                            [-0.0280794 + 0.01714936j, 0.52469293 + 0.18465894j],
                        ],
                    ]
                ),
                np.array(
                    [
                        [
                            [-0.14446909 - 0.78303072j, 0.38177657 + 0.18129146j],
                            [-0.04351395 - 0.41153353j, -0.65160872 + 0.1033291j],
                        ],
                        [
                            [0.06931483 + 0.38624822j, 0.25655634 + 0.4167283j],
                            [0.04421302 + 0.19695491j, -0.30359744 + 0.23335422j],
                        ],
                    ]
                ),
                np.array(
                    [
                        [
                            [
                                -0.20573634 - 6.86766988e-01j,
                                0.50054195 + 4.84656727e-01j,
                            ],
                            [
                                -0.20011961 - 6.67669280e-01j,
                                -0.51495486 - 4.98629579e-01j,
                            ],
                        ],
                        [
                            [
                                -0.0045725 - 1.03501982e-02j,
                                0.01522719 - 8.63473210e-05j,
                            ],
                            [
                                -0.00303454 + 7.50308252e-03j,
                                0.02285981 - 1.09334163e-03j,
                            ],
                        ],
                    ]
                ),
                np.array(
                    [
                        [
                            [
                                -0.9120095 - 1.08420217e-18j,
                                0.08355294 - 3.85506989e-01j,
                            ],
                            [
                                -0.38380973 + 2.98229987e-02j,
                                -0.11500818 + 8.85321988e-01j,
                            ],
                        ],
                        [
                            [
                                -0.09577943 - 5.20417043e-18j,
                                -0.06066857 + 2.04754492e-01j,
                            ],
                            [
                                -0.06832768 - 7.87209426e-02j,
                                0.03277715 - 2.64942194e-02j,
                            ],
                        ],
                    ]
                ),
                np.array(
                    [
                        [[0.75989596 + 0.0j], [0.54184297 - 0.25300801j]],
                        [[-0.02042084 + 0.0j], [0.02351231 - 0.01097883j]],
                    ]
                ),
            ]
        ),
        np.asarray(
            [
                np.array(
                    [
                        [
                            [
                                -0.92960922 + 0.00000000e00j,
                                0.36854673 - 2.68864921e-17j,
                            ],
                            [
                                -0.33223244 - 1.59525227e-01j,
                                -0.83801134 - 4.02380781e-01j,
                            ],
                        ]
                    ]
                ),
                np.array(
                    [
                        [
                            [-0.5379616 - 0.19887376j, 0.6648225 + 0.39655989j],
                            [-0.80107678 + 0.169728j, -0.54527674 + 0.01676543j],
                        ],
                        [
                            [-0.00420029 + 0.00890096j, 0.04919099 + 0.17130079j],
                            [-0.00358141 - 0.02013046j, 0.1902178 + 0.18760854j],
                        ],
                    ]
                ),
                np.array(
                    [
                        [
                            [-0.56968628 - 0.65286643j, 0.33197727 + 0.37227912j],
                            [-0.11328791 - 0.48578915j, -0.20492744 - 0.84151251j],
                        ],
                        [
                            [-0.00179709 - 0.01842831j, -0.02250614 - 0.01366854j],
                            [0.00566688 - 0.0047713j, -0.01787134 + 0.00693174j],
                        ],
                    ]
                ),
                np.array(
                    [
                        [
                            [-0.50233604 - 0.3298963j, 0.57608352 + 0.19007422j],
                            [-0.49257035 - 0.4072055j, 0.02252568 - 0.27556128j],
                        ],
                        [
                            [-0.31178349 - 0.145126j, -0.57225373 + 0.26338542j],
                            [-0.33336938 + 0.03129582j, -0.3086671 + 0.25186613j],
                        ],
                    ]
                ),
                np.array(
                    [
                        [
                            [-0.64198493 - 0.23476739j, 0.07574477 - 0.70898643j],
                            [-0.65784218 - 0.29842223j, -0.09736655 + 0.6662119j],
                        ],
                        [
                            [0.0618837 + 0.03547259j, 0.13360983 - 0.04392969j],
                            [0.05921332 + 0.04830463j, 0.08855585 + 0.1032419j],
                        ],
                    ]
                ),
                np.array(
                    [
                        [
                            [-0.01836685 - 0.70802213j, 0.32458698 + 0.61283983j],
                            [-0.34580298 - 0.60922651j, -0.59241706 - 0.37891578j],
                        ],
                        [
                            [-0.0014407 - 0.05724234j, 0.06436929 - 0.0854754j],
                            [-0.02206542 - 0.06216945j, 0.11065969 - 0.0289909j],
                        ],
                    ]
                ),
                np.array(
                    [
                        [
                            [-0.25879331 - 0.47791907j, 0.80765366 - 0.21057294j],
                            [-0.74017098 - 0.3931261j, -0.35849433 + 0.40445174j],
                        ],
                        [
                            [0.0117712 + 0.02639692j, -0.06336731 + 0.02546802j],
                            [-0.0370316 - 0.00338873j, -0.06168949 + 0.05277854j],
                        ],
                    ]
                ),
                np.array(
                    [
                        [
                            [
                                -0.71940084 - 2.42861287e-17j,
                                -0.62849369 + 1.41265068e-02j,
                            ],
                            [
                                -0.68413659 + 7.72047708e-02j,
                                0.6436072 - 4.05518353e-02j,
                            ],
                        ],
                        [
                            [0.03014913 + 0.00000000e00j, 0.05269066 + 3.26246219e-01j],
                            [
                                0.04697017 - 7.31013973e-02j,
                                0.15169201 + 2.38113583e-01j,
                            ],
                        ],
                    ]
                ),
                np.array(
                    [
                        [[-0.56292143 + 0.0j], [-0.68233484 + 0.3471064j]],
                        [[0.04009375 + 0.0j], [-0.02627709 + 0.01336726j]],
                    ]
                ),
            ]
        ),
        np.asarray(
            [
                np.array(
                    [
                        [
                            [
                                -0.56107566 - 7.21887810e-19j,
                                0.82776452 - 1.15502050e-17j,
                            ],
                            [
                                -0.82677146 + 4.05345073e-02j,
                                -0.56040255 + 2.74751151e-02j,
                            ],
                        ]
                    ]
                ),
                np.array(
                    [
                        [
                            [-0.74225908 - 0.16659962j, 0.01408167 + 0.60766655j],
                            [-0.57791925 + 0.28038413j, -0.41036657 - 0.55372216j],
                        ],
                        [
                            [-0.04382121 + 0.06834165j, -0.31089052 + 0.09561032j],
                            [-0.02461016 + 0.03864676j, -0.04983398 + 0.21738547j],
                        ],
                    ]
                ),
                np.array(
                    [
                        [
                            [-0.27821552 - 0.5621931j, 0.41867842 - 0.65421202j],
                            [-0.04076547 - 0.77498117j, -0.51672714 + 0.34332366j],
                        ],
                        [
                            [0.03288746 + 0.05185058j, -0.01844897 - 0.09356204j],
                            [0.02044117 + 0.0094602j, -0.0188719 - 0.04885255j],
                        ],
                    ]
                ),
                np.array(
                    [
                        [
                            [-0.63001839 - 0.1228448j, 0.61964556 - 0.37543695j],
                            [-0.71401528 - 0.27431467j, -0.56151469 + 0.24180578j],
                        ],
                        [
                            [0.02857678 - 0.00280397j, 0.14172784 + 0.14231509j],
                            [0.04405051 + 0.01243705j, 0.06971871 + 0.23688948j],
                        ],
                    ]
                ),
                np.array(
                    [
                        [
                            [-0.15310931 - 0.57409389j, 0.24262132 - 0.72704089j],
                            [-0.15661755 - 0.7859735j, -0.19302037 + 0.53417756j],
                        ],
                        [
                            [-0.001033 - 0.03782184j, -0.05682029 - 0.17451065j],
                            [0.05678851 - 0.00581888j, 0.02367664 - 0.23601018j],
                        ],
                    ]
                ),
                np.array(
                    [
                        [
                            [-0.29489378 - 0.42556727j, 0.8276743 - 0.1963455j],
                            [-0.68233106 - 0.50792132j, -0.43892914 + 0.27501241j],
                        ],
                        [
                            [-0.03989266 + 0.00174406j, -0.04855693 + 0.06478729j],
                            [-0.08193125 - 0.00795123j, 0.01970582 - 0.03419933j],
                        ],
                    ]
                ),
                np.array(
                    [
                        [
                            [-0.6242149 - 0.39104288j, 0.05223259 - 0.50331548j],
                            [-0.55510011 - 0.2591948j, -0.07251571 + 0.74265453j],
                        ],
                        [
                            [0.18676717 + 0.11708021j, -0.13488388 + 0.03322995j],
                            [0.16549914 + 0.07838003j, -0.12797075 + 0.38919996j],
                        ],
                    ]
                ),
                np.array(
                    [
                        [
                            [-0.40352987 - 0.54787462j, 0.37478991 - 0.62664006j],
                            [-0.3041432 - 0.66612632j, -0.46201139 + 0.49891201j],
                        ],
                        [
                            [0.01331457 + 0.01737411j, -0.00773853 + 0.02942618j],
                            [0.01530416 - 0.007505j, -0.01542214 + 0.057649j],
                        ],
                    ]
                ),
                np.array(
                    [
                        [
                            [
                                -0.74704476 + 1.30375311e-17j,
                                -0.35600085 + 3.88164074e-01j,
                            ],
                            [
                                -0.52339315 - 3.68489916e-01j,
                                0.67883462 - 2.06438137e-01j,
                            ],
                        ],
                        [
                            [
                                -0.16273943 + 5.74627151e-18j,
                                -0.01908329 + 2.44935401e-01j,
                            ],
                            [
                                -0.06009452 - 4.58633308e-02j,
                                -0.33453637 + 2.16533594e-01j,
                            ],
                        ],
                    ]
                ),
                np.array(
                    [
                        [[0.84553391 + 0.0j], [0.42046957 - 0.29618182j]],
                        [[0.00536852 + 0.0j], [-0.00721547 + 0.00508263j]],
                    ]
                ),
            ]
        ),
        np.asarray(
            [
                np.array(
                    [
                        [
                            [
                                -0.63836625 + 0.00000000e00j,
                                0.76973277 - 2.31958384e-17j,
                            ],
                            [
                                -0.75268644 + 1.61095183e-01j,
                                -0.62422913 + 1.33601857e-01j,
                            ],
                        ]
                    ]
                ),
                np.array(
                    [
                        [
                            [-0.54159154 - 0.23791618j, -0.12693074 + 0.78262218j],
                            [-0.79079375 + 0.12111909j, -0.22255132 - 0.51167341j],
                        ],
                        [
                            [0.03237964 - 0.0527738j, 0.1876705 + 0.09789231j],
                            [0.01726761 - 0.07692992j, 0.12338143 - 0.00512195j],
                        ],
                    ]
                ),
                np.array(
                    [
                        [
                            [-0.72087155 - 0.02124065j, 0.25692865 - 0.63811739j],
                            [-0.57768695 - 0.37891032j, -0.56637842 + 0.42497632j],
                        ],
                        [
                            [-0.0370912 - 0.01306492j, -0.11513983 + 0.08069531j],
                            [-0.02590992 - 0.01949418j, -0.07197875 - 0.02132186j],
                        ],
                    ]
                ),
                np.array(
                    [
                        [
                            [-0.49490057 - 0.44068159j, 0.58634527 - 0.40024986j],
                            [-0.14415592 - 0.71386605j, -0.60082926 - 0.08510321j],
                        ],
                        [
                            [-0.04389169 - 0.09295331j, -0.22776078 + 0.19731754j],
                            [0.04156171 - 0.13488265j, -0.12033154 + 0.14990681j],
                        ],
                    ]
                ),
                np.array(
                    [
                        [
                            [-0.83653677 - 0.1457893j, 0.33693172 - 0.3409965j],
                            [-0.50616787 - 0.08755982j, -0.49163259 + 0.60689086j],
                        ],
                        [
                            [-0.08416521 - 0.01191467j, -0.34241597 - 0.04042047j],
                            [-0.08047441 + 0.03711076j, -0.15122221 - 0.13575206j],
                        ],
                    ]
                ),
                np.array(
                    [
                        [
                            [
                                -6.12563008e-02 - 0.69892103j,
                                6.22655579e-01 - 0.32638324j,
                            ],
                            [
                                2.78811364e-01 - 0.65172616j,
                                -6.73500714e-01 - 0.01061899j,
                            ],
                        ],
                        [
                            [2.28887714e-04 + 0.0560691j, 1.74613752e-01 - 0.10083404j],
                            [
                                -2.57945788e-02 + 0.03827723j,
                                1.04702230e-01 - 0.02092875j,
                            ],
                        ],
                    ]
                ),
                np.array(
                    [
                        [
                            [-0.35010121 - 0.50929425j, 0.63656554 - 0.44889199j],
                            [-0.5704692 - 0.5313321j, -0.39449055 + 0.45781468j],
                        ],
                        [
                            [-0.07202422 + 0.026463j, -0.05292036 + 0.13544622j],
                            [-0.06638263 + 0.00227449j, -0.07491681 + 0.03611718j],
                        ],
                    ]
                ),
                np.array(
                    [
                        [
                            [-0.53125031 - 0.44827867j, 0.30447718 + 0.58022154j],
                            [-0.57682663 - 0.19888116j, -0.43727879 - 0.25854726j],
                        ],
                        [
                            [0.2210396 + 0.12167265j, 0.20206114 + 0.51494316j],
                            [0.242582 + 0.14841797j, -0.00469386 + 0.08099384j],
                        ],
                    ]
                ),
                np.array(
                    [
                        [
                            [
                                -6.89085133e-01 - 0.3535709j,
                                2.78041274e-01 - 0.56295426j,
                            ],
                            [
                                -1.60833610e-01 - 0.60455654j,
                                -7.38029841e-01 + 0.21344094j,
                            ],
                        ],
                        [
                            [
                                -5.20648502e-02 - 0.01318487j,
                                -8.35315881e-02 + 0.0923945j,
                            ],
                            [
                                3.80042389e-02 - 0.06681559j,
                                5.84304108e-04 + 0.00398235j,
                            ],
                        ],
                    ]
                ),
                np.array(
                    [
                        [
                            [
                                -0.81542085 - 2.03830008e-17j,
                                -0.27926169 - 4.92089707e-01j,
                            ],
                            [
                                -0.56856541 + 6.81658880e-02j,
                                0.49665279 + 6.23644551e-01j,
                            ],
                        ],
                        [
                            [
                                0.07563112 - 2.16840434e-18j,
                                0.11616382 - 1.31438801e-01j,
                            ],
                            [
                                0.03231489 + 2.02805827e-02j,
                                0.11490256 - 1.70680121e-02j,
                            ],
                        ],
                    ]
                ),
                np.array(
                    [
                        [[-0.75288987 + 0.0j], [-0.49645848 - 0.26668194j]],
                        [[0.03568883 + 0.0j], [-0.04200292 - 0.02256265j]],
                    ]
                ),
            ]
        ),
        np.asarray(
            [
                np.array(
                    [
                        [
                            [
                                -0.78416723 - 1.56548221e-18j,
                                0.62054957 + 2.50477153e-17j,
                            ],
                            [
                                -0.2385361 + 5.72871969e-01j,
                                -0.30142989 + 7.23918681e-01j,
                            ],
                        ]
                    ]
                ),
                np.array(
                    [
                        [
                            [-0.06863928 - 0.45205562j, 0.78398314 + 0.34705282j],
                            [-0.60664202 - 0.6199189j, -0.46025612 + 0.09495982j],
                        ],
                        [
                            [0.08769317 + 0.01587608j, 0.11781437 - 0.07078548j],
                            [0.17330264 + 0.0253856j, -0.12339463 + 0.09977311j],
                        ],
                    ]
                ),
                np.array(
                    [
                        [
                            [-0.52458466 - 0.66772652j, -0.25535251 - 0.36406196j],
                            [-0.05179034 - 0.37341288j, -0.24345564 + 0.71963621j],
                        ],
                        [
                            [0.2086418 + 0.2878948j, -0.37296014 - 0.12336764j],
                            [0.09083165 + 0.04655748j, -0.18279643 + 0.19332275j],
                        ],
                    ]
                ),
                np.array(
                    [
                        [
                            [
                                -0.36573159 - 7.27418395e-01j,
                                0.54385015 + 1.29917581e-01j,
                            ],
                            [
                                -0.21868821 - 5.34402143e-01j,
                                -0.75943417 - 2.61279092e-01j,
                            ],
                        ],
                        [
                            [
                                0.03250108 + 2.37494011e-02j,
                                -0.13046724 - 5.42285896e-02j,
                            ],
                            [
                                0.04552302 + 2.60241937e-05j,
                                -0.14874128 - 1.59689152e-02j,
                            ],
                        ],
                    ]
                ),
                np.array(
                    [
                        [
                            [-0.70175569 + 0.07482401j, 0.35781689 + 0.49600066j],
                            [-0.6673609 + 0.07090899j, -0.33581035 - 0.62983935j],
                        ],
                        [
                            [-0.11292984 + 0.02618938j, -0.03565119 + 0.15945248j],
                            [-0.07058494 + 0.18199008j, 0.20064522 + 0.22255248j],
                        ],
                    ]
                ),
                np.array(
                    [
                        [
                            [-0.32177219 - 0.6085588j, 0.35987132 + 0.53862364j],
                            [-0.63162754 - 0.29411125j, -0.67953119 - 0.19133744j],
                        ],
                        [
                            [0.04234042 + 0.05756838j, -0.07435727 + 0.07440923j],
                            [0.17861815 + 0.06043832j, -0.26020144 + 0.05686845j],
                        ],
                    ]
                ),
                np.array(
                    [
                        [
                            [-0.79036221 - 0.32223115j, 0.46292179 + 0.11226369j],
                            [-0.33750664 - 0.38859413j, -0.55976878 - 0.5368982j],
                        ],
                        [
                            [-0.00155108 - 0.02902489j, -0.35691428 + 0.07246004j],
                            [-0.03142342 - 0.06889301j, -0.19711976 + 0.00225068j],
                        ],
                    ]
                ),
                np.array(
                    [
                        [
                            [-0.30090412 - 0.65516809j, 0.6069695 + 0.20106071j],
                            [-0.52382079 - 0.43202195j, -0.62449896 + 0.15393939j],
                        ],
                        [
                            [-0.03476972 - 0.08474903j, -0.11930637 - 0.32038599j],
                            [-0.07056237 - 0.07622283j, -0.06034822 - 0.23862778j],
                        ],
                    ]
                ),
                np.array(
                    [
                        [
                            [-0.60077748 - 0.29592222j, 0.3981398 + 0.62387973j],
                            [-0.47551503 - 0.56981766j, -0.10166139 - 0.65868713j],
                        ],
                        [
                            [-0.00597214 - 0.01298852j, 0.01667859 - 0.06713401j],
                            [-0.01860742 - 0.01179615j, 0.05071703 - 0.02641287j],
                        ],
                    ]
                ),
                np.array(
                    [
                        [
                            [-0.3980743 - 0.5459833j, 0.61797263 + 0.36914222j],
                            [-0.33160867 - 0.64846841j, -0.4874358 - 0.43484914j],
                        ],
                        [
                            [0.0412892 + 0.05209187j, 0.19169424 + 0.04088923j],
                            [-0.00665881 + 0.09219977j, 0.11560778 - 0.05807443j],
                        ],
                    ]
                ),
                np.array(
                    [
                        [
                            [
                                -0.51217111 - 4.16333634e-17j,
                                -0.46051334 + 7.23462233e-01j,
                            ],
                            [
                                -0.85837835 - 5.10570552e-03j,
                                0.27801234 - 4.30078322e-01j,
                            ],
                        ],
                        [
                            [
                                0.02313259 + 1.19262239e-18j,
                                -0.00337459 - 1.88629436e-02j,
                            ],
                            [
                                -0.01464711 - 9.57265059e-03j,
                                -0.01960255 - 3.89895011e-02j,
                            ],
                        ],
                    ]
                ),
                np.array(
                    [
                        [[0.51884398 + 0.0j], [0.62120702 + 0.42731068j]],
                        [[-0.06981272 + 0.0j], [0.03958065 + 0.0272264j]],
                    ]
                ),
            ]
        ),
    ],
)
def test_get_unitary_form_of_mps_site(mps):
    # Step 1: test that result is unitary
    # Step 2: test that matrix properly encodes mps site
    for site in mps:
        unitary = _get_unitary_form_of_mps_site(site)
        assert _is_unitary(
            unitary, atol=1e-7
        )  # only 1e-7 because of number of digits in above floats
        assert len(unitary.shape) == 2
        assert unitary.shape[0] == unitary.shape[1]
        assert np.log2(unitary.shape[0]).is_integer()


def test_get_unitary_form_of_mps_site_doesnt_destory_input():
    mps = np.asarray(
        [
            np.asarray(
                [
                    [
                        [-0.57450887 + 0.0j, 0.81849836 + 0.0j],
                        [-0.75461618 + 0.31700785j, -0.52966959 + 0.2225097j],
                    ]
                ]
            ),
            np.asarray(
                [
                    [
                        [-0.80622012 - 0.15578776j, 0.07556346 + 0.3973943j],
                        [-0.5148668 + 0.00533767j, -0.14040741 - 0.75762631j],
                    ],
                    [
                        [-0.03357532 - 0.17394833j, -0.16929719 - 0.28482443j],
                        [0.02249959 - 0.16950346j, -0.36182116 - 0.04421552j],
                    ],
                ]
            ),
            np.asarray(
                [
                    [
                        [-0.69386917 - 2.40429501e-01j, 0.6462323 - 1.73402512e-01j],
                        [-0.38685763 - 5.46112579e-01j, -0.68057584 - 2.45821671e-01j],
                    ],
                    [
                        [-0.0465388 - 2.77407170e-02j, -0.15985938 - 1.45843588e-04j],
                        [-0.08004871 - 5.91459988e-02j, 0.01768885 - 5.32510290e-02j],
                    ],
                ]
            ),
            np.asarray(
                [
                    [
                        [-0.29989514 - 0.39514607j, 0.77801797 + 0.33581336j],
                        [-0.69129854 - 0.4785925j, -0.47930505 + 0.00670271j],
                    ],
                    [
                        [-0.12864227 - 0.14306525j, -0.03469456 - 0.15829426j],
                        [0.00403368 - 0.09972594j, 0.12353193 - 0.10304484j],
                    ],
                ]
            ),
            np.asarray(
                [
                    [
                        [-0.39729155 - 0.3216033j, -0.09427676 - 0.81537704j],
                        [-0.35509184 - 0.73184422j, -0.12365636 + 0.45901822j],
                    ],
                    [
                        [0.11244226 + 0.14638608j, 0.02484112 - 0.27863233j],
                        [0.13104029 + 0.16062646j, 0.11180199 + 0.09762586j],
                    ],
                ]
            ),
            np.asarray(
                [
                    [
                        [-0.46048036 - 0.37147234j, 0.11706143 - 0.79394302j],
                        [-0.64278269 - 0.47479187j, -0.06179588 + 0.57049114j],
                    ],
                    [
                        [-0.06854947 - 0.0594566j, -0.02852405 + 0.15190948j],
                        [-0.03180957 - 0.04607897j, 0.01479036 + 0.0506297j],
                    ],
                ]
            ),
            np.asarray(
                [
                    [
                        [-0.57424014 - 0.426199j, 0.54996946 - 0.41686379j],
                        [-0.50574004 - 0.48123054j, -0.6060921 + 0.36128866j],
                    ],
                    [
                        [-0.01908535 - 0.00975854j, -0.10919508 - 0.04882623j],
                        [-0.02113928 - 0.0184527j, -0.0610633 - 0.08857059j],
                    ],
                ]
            ),
            np.asarray(
                [
                    [
                        [-0.23988072 - 0.52156813j, 0.50736136 - 0.62579889j],
                        [-0.38884765 - 0.71307743j, -0.33559398 + 0.44770409j],
                    ],
                    [
                        [0.0437652 + 0.06077323j, 0.00668731 - 0.14697727j],
                        [0.02409024 + 0.06747517j, -0.10643432 - 0.07016141j],
                    ],
                ]
            ),
            np.asarray(
                [
                    [
                        [-0.755415 - 1.04083409e-17j, -0.6331034 + 1.16221928e-01j],
                        [-0.63744618 - 1.34084036e-01j, 0.75568693 + 1.98066558e-02j],
                    ],
                    [
                        [0.05726305 - 2.60208521e-18j, 0.02772025 + 1.34658635e-02j],
                        [0.03320878 + 2.54978495e-02j, 0.11003958 + 3.40448393e-02j],
                    ],
                ]
            ),
            np.asarray(
                [
                    [[0.66470115 + 0.0j], [0.66621201 - 0.26075466j]],
                    [[0.01717603 + 0.0j], [-0.01486055 + 0.0058164j]],
                ]
            ),
        ]
    )
    mps_site = mps[np.random.choice(range(10))]
    copied_mps_site = copy.deepcopy(mps_site)
    _ = _get_unitary_form_of_mps_site(mps_site)
    assert np.array_equal(mps_site, copied_mps_site)


def test_get_unitary_form_of_mps_site_raises_error_on_not_bd2_site():
    mps = np.asarray(
        [
            np.asarray(
                [
                    [
                        [
                            1.41526222e-16 + 1.23259516e-32j,
                            -1.00000000e00 + 0.00000000e00j,
                        ],
                        [
                            -8.32050294e-01 - 5.54700196e-01j,
                            -1.17756934e-16 - 7.85046229e-17j,
                        ],
                    ]
                ]
            ),
            np.asarray(
                [
                    [
                        [
                            -0.48003266 + 0.28555566j,
                            0.48947563 - 0.03392867j,
                            -0.19622376 - 0.58621629j,
                            -0.09976755 - 0.2349089j,
                        ],
                        [
                            -0.39590468 + 0.28528422j,
                            -0.35264365 + 0.23152943j,
                            -0.23310044 - 0.07243884j,
                            0.43671115 + 0.57758908j,
                        ],
                    ],
                    [
                        [
                            -0.51241456 - 0.12228558j,
                            0.41422632 - 0.30688866j,
                            0.05080941 + 0.65210839j,
                            0.15468298 + 0.07042506j,
                        ],
                        [
                            -0.41359325 - 0.03629302j,
                            -0.53243694 + 0.17901354j,
                            -0.27964085 + 0.22855533j,
                            -0.22810794 - 0.57412431j,
                        ],
                    ],
                ]
            ),
            np.asarray(
                [
                    [
                        [
                            -6.15102383e-01 + 1.04896560e-17j,
                            -1.35807211e-01 + 7.65922034e-01j,
                        ],
                        [
                            -7.79598699e-01 + 4.95223793e-02j,
                            6.00750762e-02 - 6.16198413e-01j,
                        ],
                    ],
                    [
                        [
                            -5.63505213e-02 - 5.82758668e-19j,
                            2.24563120e-02 + 3.11786555e-02j,
                        ],
                        [
                            2.07697175e-02 - 8.24633368e-02j,
                            -7.27572109e-02 + 5.00574313e-02j,
                        ],
                    ],
                    [
                        [
                            2.54059474e-03 - 4.11658012e-19j,
                            6.11791067e-03 + 3.55327687e-02j,
                        ],
                        [
                            2.07482845e-02 + 7.22427937e-03j,
                            2.45848670e-02 + 1.70093166e-02j,
                        ],
                    ],
                    [
                        [
                            -2.07430507e-02 + 1.67712524e-19j,
                            -5.22476809e-04 - 9.45403509e-03j,
                        ],
                        [
                            6.52139273e-03 + 7.31831244e-03j,
                            6.84768389e-03 + 2.07518928e-03j,
                        ],
                    ],
                ]
            ),
            np.asarray(
                [
                    [[0.46754364 + 0.0j], [0.79888162 + 0.01176266j]],
                    [[0.06411457 + 0.0j], [-0.03751477 - 0.00055236j]],
                ]
            ),
        ]
    )
    mps_site = mps[1]
    pytest.raises(AssertionError, _get_unitary_form_of_mps_site, mps_site)
